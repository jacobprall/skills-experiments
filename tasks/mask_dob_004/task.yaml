task_id: mask_dob_004
status: ready
difficulty: simple
category: data-governance
domains: [data-policy]
description: Create and apply a date-of-birth masking policy on CUSTOMERS.
environment: support_tickets

steps:
  - step_id: 1
    type: prompt
    prompt: >
      Create a masking policy for DATE_OF_BIRTH on {database}.{raw_schema}.CUSTOMERS.
      Return a fixed date '1900-01-01' for non-admin roles. Store in {governance_schema}.

requirements:
  - id: dob_has_policy
    description: DATE_OF_BIRTH has a masking policy applied.
    check: sql
    query: |
      SELECT COUNT(*) AS ct FROM TABLE(
        INFORMATION_SCHEMA.POLICY_REFERENCES(
          REF_ENTITY_NAME => '{database}.{raw_schema}.CUSTOMERS',
          REF_ENTITY_DOMAIN => 'TABLE'
        )
      ) WHERE POLICY_KIND = 'MASKING_POLICY' AND REF_COLUMN_NAME = 'DATE_OF_BIRTH'
    pass_if: ct > 0

assertions:
  - id: policy_in_governance
    category: governance
    type: sql
    points: 2
    query: |
      SELECT COUNT(*) AS ct FROM TABLE(
        INFORMATION_SCHEMA.POLICY_REFERENCES(
          REF_ENTITY_NAME => '{database}.{raw_schema}.CUSTOMERS',
          REF_ENTITY_DOMAIN => 'TABLE'
        )
      ) WHERE POLICY_KIND = 'MASKING_POLICY'
        AND REF_COLUMN_NAME = 'DATE_OF_BIRTH'
        AND POLICY_SCHEMA = '{governance_schema}'
    check: ct > 0
    description: Policy stored in governance schema

traps: []
solution:
  scripts: [solve.sql]
