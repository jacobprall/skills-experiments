USE ROLE {admin_role};
USE WAREHOUSE {warehouse};

CREATE OR REPLACE VIEW {database}.{analytics_schema}.TABLE_PROFILE AS
SELECT 'CUSTOMERS' AS TABLE_NAME, COUNT(*) AS ROW_COUNT, 11 AS COLUMN_COUNT,
    ROUND(100.0 * (SUM(CASE WHEN SSN IS NULL THEN 1 ELSE 0 END) + SUM(CASE WHEN EMAIL IS NULL THEN 1 ELSE 0 END)) / (COUNT(*) * 2), 2) AS AVG_NULL_PCT,
    TIMESTAMPDIFF('HOUR', MAX(CREATED_AT), CURRENT_TIMESTAMP()) AS HOURS_SINCE_LATEST
FROM {database}.{raw_schema}.CUSTOMERS
UNION ALL
SELECT 'ORDERS', COUNT(*), 7,
    ROUND(100.0 * SUM(CASE WHEN STATUS IS NULL THEN 1 ELSE 0 END) / COUNT(*), 2),
    TIMESTAMPDIFF('HOUR', MAX(CREATED_AT), CURRENT_TIMESTAMP())
FROM {database}.{raw_schema}.ORDERS
UNION ALL
SELECT 'SUPPORT_TICKETS', COUNT(*), 9,
    ROUND(100.0 * SUM(CASE WHEN SUBJECT IS NULL THEN 1 ELSE 0 END) / COUNT(*), 2),
    TIMESTAMPDIFF('HOUR', MAX(CREATED_AT), CURRENT_TIMESTAMP())
FROM {database}.{raw_schema}.SUPPORT_TICKETS;

CREATE OR REPLACE VIEW {database}.{analytics_schema}.COLUMN_QUALITY AS
SELECT 'CUSTOMERS' AS TABLE_NAME, 'SSN' AS COLUMN_NAME,
    SUM(CASE WHEN SSN IS NULL THEN 1 ELSE 0 END) AS NULL_COUNT,
    COUNT(DISTINCT SSN) AS DISTINCT_COUNT, NULL AS MIN_VAL, NULL AS MAX_VAL
FROM {database}.{raw_schema}.CUSTOMERS
UNION ALL
SELECT 'ORDERS', 'TOTAL_AMOUNT',
    SUM(CASE WHEN TOTAL_AMOUNT IS NULL THEN 1 ELSE 0 END),
    COUNT(DISTINCT TOTAL_AMOUNT), MIN(TOTAL_AMOUNT)::VARCHAR, MAX(TOTAL_AMOUNT)::VARCHAR
FROM {database}.{raw_schema}.ORDERS;

CREATE OR REPLACE VIEW {database}.{analytics_schema}.QUALITY_SCORECARD AS
SELECT TABLE_NAME,
    GREATEST(0, 100 - AVG_NULL_PCT - CASE WHEN HOURS_SINCE_LATEST > 24 THEN 20 ELSE 0 END) AS QUALITY_SCORE,
    ROW_COUNT, AVG_NULL_PCT, HOURS_SINCE_LATEST
FROM {database}.{analytics_schema}.TABLE_PROFILE;
