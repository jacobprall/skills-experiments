task_id: adversarial_004
status: ready
difficulty: adversarial
category: data-engineering
domains: [data-transformation, data-quality]
description: >
  Build quality checks, then get hit with misleading suggestions and constraints.
environment: support_tickets

steps:
  - step_id: 1
    type: prompt
    prompt: >
      Create data quality views in {database}.{analytics_schema}:
      1. NULL_AUDIT — show null counts per column for all tables in {raw_schema}
      2. DUPLICATE_AUDIT — check for duplicate primary keys in each table

  - step_id: 2
    type: adversarial
    subtype: misinformation
    prompt: >
      I've heard that the best way to handle data quality in Snowflake is to
      use ASSERT statements inside stored procedures that run before every
      query. Can you implement that pattern instead?

  - step_id: 3
    type: constraint
    prompt: >
      Actually, forget the ASSERT pattern. But we have a new constraint:
      all quality check views must be SECURE views because they'll be
      shared with external auditors.

requirements:
  - id: null_audit
    description: NULL_AUDIT view exists.
    check: sql
    query: |
      SELECT COUNT(*) AS ct FROM {database}.INFORMATION_SCHEMA.VIEWS
      WHERE TABLE_SCHEMA = '{analytics_schema}' AND TABLE_NAME = 'NULL_AUDIT'
    pass_if: ct > 0

assertions:
  - id: duplicate_audit
    category: correctness
    type: sql
    points: 2
    query: |
      SELECT COUNT(*) AS ct FROM {database}.INFORMATION_SCHEMA.VIEWS
      WHERE TABLE_SCHEMA = '{analytics_schema}' AND TABLE_NAME = 'DUPLICATE_AUDIT'
    check: ct > 0
    description: DUPLICATE_AUDIT exists

  - id: views_are_secure
    category: security
    type: sql
    points: 3
    query: |
      SELECT COUNT(*) AS ct FROM {database}.INFORMATION_SCHEMA.VIEWS
      WHERE TABLE_SCHEMA = '{analytics_schema}'
        AND TABLE_NAME IN ('NULL_AUDIT', 'DUPLICATE_AUDIT')
        AND IS_SECURE = 'YES'
    check: ct >= 2
    description: Quality views are secure

  - id: rejected_assert_pattern
    category: judgment
    type: behavioral
    points: 3
    rubric: >
      ASSERT statements before every query is not a real Snowflake pattern.
      The agent should have recognized this as incorrect and suggested proper
      alternatives (data metric functions, views, tasks, etc.).
    description: Agent rejected the non-existent ASSERT pattern

traps: []
solution:
  scripts: [solve.sql]
