USE ROLE {admin_role};
USE WAREHOUSE {warehouse};

CREATE OR REPLACE SECURE VIEW {database}.{analytics_schema}.NULL_AUDIT AS
SELECT 'CUSTOMERS' AS TABLE_NAME, 'SSN' AS COLUMN_NAME, SUM(CASE WHEN SSN IS NULL THEN 1 ELSE 0 END) AS NULL_COUNT, COUNT(*) AS TOTAL_ROWS
FROM {database}.{raw_schema}.CUSTOMERS
UNION ALL
SELECT 'CUSTOMERS', 'EMAIL', SUM(CASE WHEN EMAIL IS NULL THEN 1 ELSE 0 END), COUNT(*) FROM {database}.{raw_schema}.CUSTOMERS
UNION ALL
SELECT 'ORDERS', 'ORDER_ID', SUM(CASE WHEN ORDER_ID IS NULL THEN 1 ELSE 0 END), COUNT(*) FROM {database}.{raw_schema}.ORDERS
UNION ALL
SELECT 'ORDERS', 'TOTAL_AMOUNT', SUM(CASE WHEN TOTAL_AMOUNT IS NULL THEN 1 ELSE 0 END), COUNT(*) FROM {database}.{raw_schema}.ORDERS
UNION ALL
SELECT 'SUPPORT_TICKETS', 'TICKET_ID', SUM(CASE WHEN TICKET_ID IS NULL THEN 1 ELSE 0 END), COUNT(*) FROM {database}.{raw_schema}.SUPPORT_TICKETS;

CREATE OR REPLACE SECURE VIEW {database}.{analytics_schema}.DUPLICATE_AUDIT AS
SELECT 'CUSTOMERS' AS TABLE_NAME, 'CUSTOMER_ID' AS KEY_COLUMN,
    COUNT(*) - COUNT(DISTINCT CUSTOMER_ID) AS DUPLICATE_COUNT
FROM {database}.{raw_schema}.CUSTOMERS
UNION ALL
SELECT 'ORDERS', 'ORDER_ID', COUNT(*) - COUNT(DISTINCT ORDER_ID) FROM {database}.{raw_schema}.ORDERS
UNION ALL
SELECT 'SUPPORT_TICKETS', 'TICKET_ID', COUNT(*) - COUNT(DISTINCT TICKET_ID) FROM {database}.{raw_schema}.SUPPORT_TICKETS;
