USE ROLE {admin_role};
USE WAREHOUSE {warehouse};

CREATE OR REPLACE STREAM {database}.{staging_schema}.ORDERS_CHANGES
    ON TABLE {database}.{raw_schema}.ORDERS;

CREATE OR REPLACE TABLE {database}.{analytics_schema}.ORDERS_INCREMENTAL (
    ORDER_ID INT,
    CUSTOMER_ID INT,
    ORDER_DATE DATE,
    TOTAL_AMOUNT DECIMAL(10,2),
    STATUS VARCHAR(20),
    PRODUCT_CATEGORY VARCHAR(50),
    CREATED_AT TIMESTAMP_NTZ,
    LOADED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()
);

CREATE OR REPLACE TASK {database}.{staging_schema}.LOAD_ORDERS
    WAREHOUSE = {warehouse}
    SCHEDULE = 'USING CRON */5 * * * * UTC'
    WHEN SYSTEM$STREAM_HAS_DATA('{database}.{staging_schema}.ORDERS_CHANGES')
AS
INSERT INTO {database}.{analytics_schema}.ORDERS_INCREMENTAL
    (ORDER_ID, CUSTOMER_ID, ORDER_DATE, TOTAL_AMOUNT, STATUS, PRODUCT_CATEGORY, CREATED_AT)
SELECT ORDER_ID, CUSTOMER_ID, ORDER_DATE, TOTAL_AMOUNT, STATUS, PRODUCT_CATEGORY, CREATED_AT
FROM {database}.{staging_schema}.ORDERS_CHANGES;
