task_id: mask_email_002
status: ready
difficulty: simple
category: data-governance
domains: [data-policy]
description: Create and apply an email masking policy on the CUSTOMERS table.
environment: support_tickets

steps:
  - step_id: 1
    type: prompt
    prompt: >
      Create a masking policy for the EMAIL column on {database}.{raw_schema}.CUSTOMERS.
      It should show only the domain (e.g., '***@example.com') for non-admin roles
      and full cleartext for {admin_role}. Store the policy in {governance_schema}.

requirements:
  - id: email_has_policy
    description: EMAIL column has a masking policy applied.
    check: sql
    query: |
      SELECT COUNT(*) AS ct FROM TABLE(
        INFORMATION_SCHEMA.POLICY_REFERENCES(
          REF_ENTITY_NAME => '{database}.{raw_schema}.CUSTOMERS',
          REF_ENTITY_DOMAIN => 'TABLE'
        )
      ) WHERE POLICY_KIND = 'MASKING_POLICY' AND REF_COLUMN_NAME = 'EMAIL'
    pass_if: ct > 0

assertions:
  - id: policy_in_governance
    category: governance
    type: sql
    points: 2
    query: |
      SELECT COUNT(*) AS ct FROM TABLE(
        INFORMATION_SCHEMA.POLICY_REFERENCES(
          REF_ENTITY_NAME => '{database}.{raw_schema}.CUSTOMERS',
          REF_ENTITY_DOMAIN => 'TABLE'
        )
      ) WHERE POLICY_KIND = 'MASKING_POLICY'
        AND REF_COLUMN_NAME = 'EMAIL'
        AND POLICY_SCHEMA = '{governance_schema}'
    check: ct > 0
    description: Policy stored in governance schema

traps: []
solution:
  scripts: [solve.sql]
