USE ROLE {admin_role};
USE WAREHOUSE {warehouse};

CREATE OR REPLACE SECURE VIEW {database}.{analytics_schema}.SHARED_ORDER_METRICS AS
SELECT
    PRODUCT_CATEGORY,
    DATE_TRUNC('MONTH', ORDER_DATE) AS MONTH,
    COUNT(*) AS ORDER_COUNT,
    SUM(TOTAL_AMOUNT) AS TOTAL_REVENUE,
    AVG(TOTAL_AMOUNT) AS AVG_ORDER_VALUE
FROM {database}.{raw_schema}.ORDERS
GROUP BY PRODUCT_CATEGORY, DATE_TRUNC('MONTH', ORDER_DATE);

CREATE OR REPLACE SECURE VIEW {database}.{analytics_schema}.SHARED_TICKET_METRICS AS
SELECT
    PRIORITY,
    DATE_TRUNC('MONTH', CREATED_AT) AS MONTH,
    COUNT(*) AS TICKET_COUNT,
    AVG(TIMESTAMPDIFF('HOUR', CREATED_AT, COALESCE(RESOLVED_AT, CURRENT_TIMESTAMP()))) AS AVG_RESOLUTION_HOURS
FROM {database}.{raw_schema}.SUPPORT_TICKETS
GROUP BY PRIORITY, DATE_TRUNC('MONTH', CREATED_AT);
