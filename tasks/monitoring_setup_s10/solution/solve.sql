USE ROLE {admin_role};
USE WAREHOUSE {warehouse};

CREATE OR REPLACE VIEW {database}.{analytics_schema}.SLOW_QUERIES AS
SELECT
    QUERY_ID, WAREHOUSE_NAME,
    TOTAL_ELAPSED_TIME / 1000 AS EXECUTION_TIME_SECONDS,
    LEFT(QUERY_TEXT, 200) AS QUERY_TEXT_PREVIEW,
    START_TIME, USER_NAME
FROM SNOWFLAKE.ACCOUNT_USAGE.QUERY_HISTORY
WHERE START_TIME >= DATEADD('DAY', -7, CURRENT_TIMESTAMP())
  AND TOTAL_ELAPSED_TIME > 60000
ORDER BY TOTAL_ELAPSED_TIME DESC;

CREATE OR REPLACE VIEW {database}.{analytics_schema}.FAILED_QUERIES AS
SELECT
    QUERY_ID, WAREHOUSE_NAME,
    LEFT(QUERY_TEXT, 200) AS QUERY_TEXT_PREVIEW,
    ERROR_CODE, ERROR_MESSAGE,
    START_TIME, USER_NAME
FROM SNOWFLAKE.ACCOUNT_USAGE.QUERY_HISTORY
WHERE START_TIME >= DATEADD('DAY', -7, CURRENT_TIMESTAMP())
  AND EXECUTION_STATUS = 'FAIL'
ORDER BY START_TIME DESC;
