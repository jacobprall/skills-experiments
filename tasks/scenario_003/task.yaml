task_id: scenario_003
status: ready
difficulty: complex
category: data-governance
domains: [data-policy, data-engineering, data-quality]
description: >
  Full governance + quality audit: classify PII, protect it, set up
  data quality checks, and create a governance dashboard.
environment: support_tickets

steps:
  - step_id: 1
    type: prompt
    prompt: >
      We're preparing for a compliance audit. In {database}:
      1. Classify CUSTOMERS to detect PII (SYSTEM$CLASSIFY)
      2. Create masking policies in {governance_schema} for all PII columns
      3. Apply them to CUSTOMERS
      4. Create a data quality view {analytics_schema}.DATA_QUALITY_REPORT
         checking for NULLs, duplicates, and invalid values across all 3 tables

  - step_id: 2
    type: prompt
    prompt: >
      Now create a governance dashboard view {analytics_schema}.GOVERNANCE_STATUS
      that shows: total tables, tables with masking policies, tables with row
      access policies, and the count of tagged PII columns. This gives auditors
      a single-pane view of our governance posture.

requirements:
  - id: pii_masked
    description: PII columns protected with masking policies.
    check: sql
    query: |
      SELECT COUNT(DISTINCT REF_COLUMN_NAME) AS ct FROM TABLE(
        INFORMATION_SCHEMA.POLICY_REFERENCES(
          REF_ENTITY_NAME => '{database}.{raw_schema}.CUSTOMERS',
          REF_ENTITY_DOMAIN => 'TABLE'
        )
      ) WHERE POLICY_KIND = 'MASKING_POLICY'
    pass_if: ct >= 3

  - id: quality_report
    description: Data quality report exists.
    check: sql
    query: |
      SELECT COUNT(*) AS ct FROM {database}.INFORMATION_SCHEMA.VIEWS
      WHERE TABLE_SCHEMA = '{analytics_schema}' AND TABLE_NAME = 'DATA_QUALITY_REPORT'
    pass_if: ct > 0

assertions:
  - id: governance_dashboard
    category: governance
    type: sql
    points: 3
    query: |
      SELECT COUNT(*) AS ct FROM {database}.INFORMATION_SCHEMA.VIEWS
      WHERE TABLE_SCHEMA = '{analytics_schema}' AND TABLE_NAME = 'GOVERNANCE_STATUS'
    check: ct > 0
    description: Governance status dashboard exists

  - id: classify_ran
    category: pii_discovery
    type: sql
    points: 2
    query: |
      SELECT COUNT(*) AS ct FROM TABLE(
        INFORMATION_SCHEMA.TAG_REFERENCES('{database}.{raw_schema}.CUSTOMERS', 'TABLE')
      ) WHERE TAG_NAME = 'SEMANTIC_CATEGORY'
    check: ct > 0
    description: Classification was run

traps:
  - id: legacy_mask_email
    description: Broken legacy email masking policy exists and returns NULL.
    detection_method: behavioral
    points: 3

solution:
  scripts: [solve.sql]
