USE ROLE {admin_role};
USE WAREHOUSE {warehouse};

CREATE OR REPLACE DYNAMIC TABLE {database}.{analytics_schema}.CUSTOMER_360
    TARGET_LAG = '1 minute'
    WAREHOUSE = {warehouse}
AS
SELECT
    c.CUSTOMER_ID,
    c.CUSTOMER_NAME,
    c.EMAIL,
    COALESCE(o.TOTAL_ORDERS, 0) AS TOTAL_ORDERS,
    COALESCE(o.TOTAL_SPENT, 0) AS TOTAL_SPENT,
    o.LAST_ORDER_DATE,
    COALESCE(t.OPEN_TICKETS, 0) AS OPEN_TICKETS,
    COALESCE(t.RESOLVED_TICKETS, 0) AS RESOLVED_TICKETS
FROM {database}.{raw_schema}.CUSTOMERS c
LEFT JOIN (
    SELECT CUSTOMER_ID,
           COUNT(*) AS TOTAL_ORDERS,
           SUM(TOTAL_AMOUNT) AS TOTAL_SPENT,
           MAX(ORDER_DATE) AS LAST_ORDER_DATE
    FROM {database}.{raw_schema}.ORDERS GROUP BY CUSTOMER_ID
) o ON c.CUSTOMER_ID = o.CUSTOMER_ID
LEFT JOIN (
    SELECT CUSTOMER_ID,
           SUM(CASE WHEN STATUS != 'resolved' THEN 1 ELSE 0 END) AS OPEN_TICKETS,
           SUM(CASE WHEN STATUS = 'resolved' THEN 1 ELSE 0 END) AS RESOLVED_TICKETS
    FROM {database}.{raw_schema}.SUPPORT_TICKETS GROUP BY CUSTOMER_ID
) t ON c.CUSTOMER_ID = t.CUSTOMER_ID;
