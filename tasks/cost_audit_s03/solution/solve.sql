USE ROLE {admin_role};
USE WAREHOUSE {warehouse};

CREATE OR REPLACE VIEW {database}.{analytics_schema}.WAREHOUSE_COST_SUMMARY AS
SELECT
    WAREHOUSE_NAME,
    SUM(CREDITS_USED) AS TOTAL_CREDITS,
    AVG(CREDITS_USED) AS AVG_CREDITS_PER_HOUR,
    COUNT(DISTINCT DATE_TRUNC('HOUR', START_TIME)) AS TOTAL_HOURS_RUNNING
FROM SNOWFLAKE.ACCOUNT_USAGE.WAREHOUSE_METERING_HISTORY
WHERE START_TIME >= DATEADD('DAY', -30, CURRENT_TIMESTAMP())
GROUP BY WAREHOUSE_NAME
ORDER BY TOTAL_CREDITS DESC;
