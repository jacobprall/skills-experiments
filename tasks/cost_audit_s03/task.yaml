task_id: cost_audit_s03
status: ready
difficulty: standard
category: admin
domains: [cost-management]
description: Query warehouse usage and identify cost optimization opportunities.
environment: support_tickets

steps:
  - step_id: 1
    type: prompt
    prompt: >
      Create a view {database}.{analytics_schema}.WAREHOUSE_COST_SUMMARY that queries
      SNOWFLAKE.ACCOUNT_USAGE.WAREHOUSE_METERING_HISTORY from the last 30 days.
      Include warehouse_name, total_credits, avg_credits_per_hour, and
      total_hours_running. Order by total_credits descending.

requirements:
  - id: view_exists
    description: Cost summary view exists.
    check: sql
    query: |
      SELECT COUNT(*) AS ct FROM {database}.INFORMATION_SCHEMA.VIEWS
      WHERE TABLE_SCHEMA = '{analytics_schema}' AND TABLE_NAME = 'WAREHOUSE_COST_SUMMARY'
    pass_if: ct > 0

assertions:
  - id: view_has_columns
    category: correctness
    type: sql
    points: 3
    query: |
      SELECT COUNT(*) AS ct FROM {database}.INFORMATION_SCHEMA.COLUMNS
      WHERE TABLE_SCHEMA = '{analytics_schema}' AND TABLE_NAME = 'WAREHOUSE_COST_SUMMARY'
    check: ct >= 3
    description: View has expected columns

traps: []
solution:
  scripts: [solve.sql]
