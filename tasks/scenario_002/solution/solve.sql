USE ROLE {admin_role};
USE WAREHOUSE {warehouse};

CREATE OR REPLACE TABLE {database}.{staging_schema}.STG_CUSTOMERS AS
SELECT CUSTOMER_ID, TRIM(CUSTOMER_NAME) AS CUSTOMER_NAME, TRIM(EMAIL) AS EMAIL,
       PHONE, SSN, DATE_OF_BIRTH, CREATED_AT
FROM {database}.{raw_schema}.CUSTOMERS;

CREATE OR REPLACE TABLE {database}.{staging_schema}.STG_ORDERS AS
SELECT ORDER_ID, CUSTOMER_ID, ORDER_DATE, TOTAL_AMOUNT, UPPER(STATUS) AS STATUS,
       UPPER(PRODUCT_CATEGORY) AS PRODUCT_CATEGORY, CREATED_AT
FROM {database}.{raw_schema}.ORDERS;

CREATE OR REPLACE TABLE {database}.{staging_schema}.STG_TICKETS AS
SELECT TICKET_ID, CUSTOMER_ID, SUBJECT, UPPER(PRIORITY) AS PRIORITY,
       UPPER(STATUS) AS STATUS, CREATED_AT, RESOLVED_AT
FROM {database}.{raw_schema}.SUPPORT_TICKETS;

CREATE OR REPLACE DYNAMIC TABLE {database}.{analytics_schema}.CUSTOMER_360
    TARGET_LAG = '1 minute' WAREHOUSE = {warehouse}
AS
SELECT c.CUSTOMER_ID, c.CUSTOMER_NAME, c.EMAIL,
    COALESCE(o.TOTAL_ORDERS, 0) AS TOTAL_ORDERS,
    COALESCE(o.TOTAL_SPENT, 0) AS TOTAL_SPENT,
    COALESCE(t.OPEN_TICKETS, 0) AS OPEN_TICKETS
FROM {database}.{staging_schema}.STG_CUSTOMERS c
LEFT JOIN (SELECT CUSTOMER_ID, COUNT(*) AS TOTAL_ORDERS, SUM(TOTAL_AMOUNT) AS TOTAL_SPENT
           FROM {database}.{staging_schema}.STG_ORDERS GROUP BY CUSTOMER_ID) o
    ON c.CUSTOMER_ID = o.CUSTOMER_ID
LEFT JOIN (SELECT CUSTOMER_ID, SUM(CASE WHEN STATUS != 'RESOLVED' THEN 1 ELSE 0 END) AS OPEN_TICKETS
           FROM {database}.{staging_schema}.STG_TICKETS GROUP BY CUSTOMER_ID) t
    ON c.CUSTOMER_ID = t.CUSTOMER_ID;

CREATE OR REPLACE STREAM {database}.{staging_schema}.ORDERS_CDC
    ON TABLE {database}.{raw_schema}.ORDERS;

CREATE OR REPLACE TABLE {database}.{staging_schema}.STG_ORDERS_INCREMENTAL LIKE {database}.{staging_schema}.STG_ORDERS;
ALTER TABLE {database}.{staging_schema}.STG_ORDERS_INCREMENTAL ADD COLUMN LOADED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP();

CREATE OR REPLACE TASK {database}.{staging_schema}.INCREMENTAL_ORDERS_LOAD
    WAREHOUSE = {warehouse}
    SCHEDULE = 'USING CRON */5 * * * * UTC'
    WHEN SYSTEM$STREAM_HAS_DATA('{database}.{staging_schema}.ORDERS_CDC')
AS INSERT INTO {database}.{staging_schema}.STG_ORDERS_INCREMENTAL
    (ORDER_ID, CUSTOMER_ID, ORDER_DATE, TOTAL_AMOUNT, STATUS, PRODUCT_CATEGORY, CREATED_AT)
SELECT ORDER_ID, CUSTOMER_ID, ORDER_DATE, TOTAL_AMOUNT, UPPER(STATUS), UPPER(PRODUCT_CATEGORY), CREATED_AT
FROM {database}.{staging_schema}.ORDERS_CDC;
