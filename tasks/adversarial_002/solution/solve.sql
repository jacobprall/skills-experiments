USE ROLE {admin_role};
USE WAREHOUSE {warehouse};

CREATE OR REPLACE DYNAMIC TABLE {database}.{analytics_schema}.ORDER_METRICS
    TARGET_LAG = '1 minute' WAREHOUSE = {warehouse}
AS
SELECT ORDER_DATE, PRODUCT_CATEGORY, COUNT(*) AS ORDER_COUNT,
       SUM(TOTAL_AMOUNT) AS DAILY_REVENUE
FROM {database}.{raw_schema}.ORDERS
GROUP BY ORDER_DATE, PRODUCT_CATEGORY;

CREATE OR REPLACE DYNAMIC TABLE {database}.{analytics_schema}.CUSTOMER_RFM_DT
    TARGET_LAG = '1 minute' WAREHOUSE = {warehouse}
AS
SELECT CUSTOMER_ID,
    DATEDIFF('DAY', MAX(ORDER_DATE), CURRENT_DATE()) AS RECENCY_DAYS,
    COUNT(*) AS FREQUENCY,
    SUM(TOTAL_AMOUNT) AS MONETARY,
    NTILE(5) OVER (ORDER BY DATEDIFF('DAY', MAX(ORDER_DATE), CURRENT_DATE()) ASC) AS R_SCORE,
    NTILE(5) OVER (ORDER BY COUNT(*) DESC) AS F_SCORE,
    NTILE(5) OVER (ORDER BY SUM(TOTAL_AMOUNT) DESC) AS M_SCORE
FROM {database}.{raw_schema}.ORDERS
GROUP BY CUSTOMER_ID;

CREATE OR REPLACE VIEW {database}.{analytics_schema}.TOP_CUSTOMERS_BY_VALUE AS
SELECT c.CUSTOMER_ID, c.CUSTOMER_NAME, r.MONETARY, r.FREQUENCY, r.RECENCY_DAYS
FROM {database}.{analytics_schema}.CUSTOMER_RFM_DT r
JOIN {database}.{raw_schema}.CUSTOMERS c ON r.CUSTOMER_ID = c.CUSTOMER_ID
ORDER BY r.MONETARY DESC
LIMIT 50;
