USE ROLE {admin_role};
USE WAREHOUSE {warehouse};

CREATE OR REPLACE VIEW {database}.{analytics_schema}.ENRICHED_TICKETS AS
WITH customer_ltv AS (
    SELECT CUSTOMER_ID, SUM(TOTAL_AMOUNT) AS LIFETIME_VALUE,
           NTILE(5) OVER (ORDER BY SUM(TOTAL_AMOUNT) DESC) AS LTV_QUINTILE
    FROM {database}.{raw_schema}.ORDERS GROUP BY CUSTOMER_ID
)
SELECT
    t.TICKET_ID, t.SUBJECT, t.BODY, t.PRIORITY, t.STATUS AS TICKET_STATUS,
    t.ASSIGNED_TO, t.CREATED_AT, t.RESOLVED_AT,
    c.CUSTOMER_NAME, c.EMAIL,
    COALESCE(l.LIFETIME_VALUE, 0) AS CUSTOMER_LTV,
    (CASE t.PRIORITY WHEN 'high' THEN 3 WHEN 'medium' THEN 2 ELSE 1 END)
    * (CASE WHEN l.LTV_QUINTILE = 1 THEN 2 ELSE 1 END) AS PRIORITY_SCORE
FROM {database}.{raw_schema}.SUPPORT_TICKETS t
JOIN {database}.{raw_schema}.CUSTOMERS c ON t.CUSTOMER_ID = c.CUSTOMER_ID
LEFT JOIN customer_ltv l ON t.CUSTOMER_ID = l.CUSTOMER_ID;
