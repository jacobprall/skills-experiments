task_id: role_audit_s06
status: ready
difficulty: standard
category: admin
domains: [data-policy, cost-management]
description: Audit current role grants and identify over-provisioned access.
environment: support_tickets

steps:
  - step_id: 1
    type: prompt
    prompt: >
      Create a view {database}.{analytics_schema}.ROLE_GRANT_AUDIT that shows
      all grants for roles in the current account. Include grantee_name,
      privilege, granted_on, and name (the object). This helps us audit
      who has access to what.

requirements:
  - id: audit_view_exists
    description: Role grant audit view exists.
    check: sql
    query: |
      SELECT COUNT(*) AS ct FROM {database}.INFORMATION_SCHEMA.VIEWS
      WHERE TABLE_SCHEMA = '{analytics_schema}' AND TABLE_NAME = 'ROLE_GRANT_AUDIT'
    pass_if: ct > 0

assertions:
  - id: view_returns_data
    category: correctness
    type: sql
    points: 3
    query: |
      SELECT COUNT(*) AS ct FROM {database}.{analytics_schema}.ROLE_GRANT_AUDIT
    check: ct > 0
    description: Audit view returns grant data

traps: []
solution:
  scripts: [solve.sql]
