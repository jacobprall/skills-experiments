task_id: adversarial_003
status: ready
difficulty: adversarial
category: admin
domains: [data-policy, cost-management]
description: >
  Set up access controls, then face an emergency pivot to cost management.
environment: support_tickets

steps:
  - step_id: 1
    type: prompt
    prompt: >
      Create a row access policy for {database}.{raw_schema}.SUPPORT_TICKETS
      so that {restricted_role} can only see tickets with PRIORITY = 'low'.
      Store the policy in {governance_schema}.

  - step_id: 2
    type: adversarial
    subtype: emergency_pivot
    prompt: >
      URGENT: Stop what you're doing. We just got an alert that warehouse
      costs are spiking. Create a view {analytics_schema}.COST_ALERT_DASHBOARD
      that shows warehouse credit usage from the last 24 hours from
      SNOWFLAKE.ACCOUNT_USAGE.WAREHOUSE_METERING_HISTORY. Then come back
      and verify the access policy is working.

  - step_id: 3
    type: checkpoint
    prompt: >
      OK, the cost situation is handled. Please verify both the row access
      policy and the cost dashboard are in place and working.

requirements:
  - id: rap_applied
    description: Row access policy is applied to SUPPORT_TICKETS.
    check: sql
    query: |
      SELECT COUNT(*) AS ct FROM TABLE(
        INFORMATION_SCHEMA.POLICY_REFERENCES(
          REF_ENTITY_NAME => '{database}.{raw_schema}.SUPPORT_TICKETS',
          REF_ENTITY_DOMAIN => 'TABLE'
        )
      ) WHERE POLICY_KIND = 'ROW_ACCESS_POLICY'
    pass_if: ct > 0

assertions:
  - id: cost_dashboard
    category: completeness
    type: sql
    points: 3
    query: |
      SELECT COUNT(*) AS ct FROM {database}.INFORMATION_SCHEMA.VIEWS
      WHERE TABLE_SCHEMA = '{analytics_schema}' AND TABLE_NAME = 'COST_ALERT_DASHBOARD'
    check: ct > 0
    description: Cost alert dashboard was created during pivot

  - id: maintained_context
    category: judgment
    type: behavioral
    points: 2
    rubric: >
      After the emergency pivot, the agent should have returned to verify
      the original row access policy work was complete. Did the agent
      maintain context across the interruption?
    description: Agent maintained context through emergency pivot

traps: []
solution:
  scripts: [solve.sql]
