USE ROLE {admin_role};
USE WAREHOUSE {warehouse};

CREATE OR REPLACE ROW ACCESS POLICY {database}.{governance_schema}.RAP_TICKETS AS
(priority_val VARCHAR) RETURNS BOOLEAN ->
    CASE
        WHEN CURRENT_ROLE() IN ('{admin_role}') THEN TRUE
        WHEN CURRENT_ROLE() IN ('{restricted_role}') AND priority_val = 'low' THEN TRUE
        ELSE FALSE
    END;

ALTER TABLE {database}.{raw_schema}.SUPPORT_TICKETS
    ADD ROW ACCESS POLICY {database}.{governance_schema}.RAP_TICKETS ON (PRIORITY);

CREATE OR REPLACE VIEW {database}.{analytics_schema}.COST_ALERT_DASHBOARD AS
SELECT WAREHOUSE_NAME, SUM(CREDITS_USED) AS CREDITS_24H,
       COUNT(*) AS METERING_EVENTS
FROM SNOWFLAKE.ACCOUNT_USAGE.WAREHOUSE_METERING_HISTORY
WHERE START_TIME >= DATEADD('HOUR', -24, CURRENT_TIMESTAMP())
GROUP BY WAREHOUSE_NAME ORDER BY CREDITS_24H DESC;
